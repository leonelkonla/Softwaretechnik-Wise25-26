name: CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    # Compute build number = commit count (einfachste, gewünschte Variante)
    - name: Compute build number (commit count)
      run: echo "BUILD_NUMBER=$(git rev-list --count HEAD)" >> $GITHUB_ENV

    - name: Build with Maven (package, skip tests here)
      run: mvn -DbuildNumber=${{ env.BUILD_NUMBER }} clean package -DskipTests

    - name: Run Tests
      run: mvn test
      env:
        JAVA_TOOL_OPTIONS: -Djava.awt.headless=true -Dtestfx.robot=glass -Dtestfx.headless=true -Dprism.order=sw

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: target/surefire-reports/

    - name: Generate JaCoCo report
      run: mvn jacoco:report

    # Quality Gate: Coverage check (50% threshold, Build fail wenn drunter)
    - name: Quality Gate - Coverage Check
      run: |
        python - <<'PY'
import xml.etree.ElementTree as ET, sys
try:
    tree = ET.parse('target/site/jacoco/jacoco.xml')
except Exception as e:
    print('Konnte jacoco.xml nicht lesen:', e)
    sys.exit(1)
root = tree.getroot()
# Suche nach INSTRUCTION counter, sonst FIRST available
cov = None
for c in root.findall('.//counter'):
    if c.attrib.get('type') == 'INSTRUCTION':
        missed = int(c.attrib['missed'])
        covered = int(c.attrib['covered'])
        total = missed + covered
        cov = (covered * 100.0 / total) if total else 0
        break
if cov is None:
    print('Keine Coverage-Daten gefunden in jacoco.xml')
    sys.exit(1)
print(f'Code Coverage: {cov:.1f}%')
if cov < 50:
    print('❌ Coverage unter 50% - Build fehlgeschlagen!')
    sys.exit(1)
print('✅ Coverage OK')
PY

    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: target/*.jar
